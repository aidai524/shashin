# 积分系统开发进度

> 更新时间：2026-01-09

## 需求概述

实现完整的会员积分系统，包括：
- 点卡兑换
- 优惠码折扣
- 新人/邀请积分奖励

---

## 开发任务清单

### ✅ 已完成

#### 1. 数据库设计
- **文件**: `migrations/0001_init_points_system.sql`
- **内容**: 创建 9 张数据表
  - `user_wallets` - 用户钱包
  - `points_ledger` - 积分账本（含幂等键）
  - `subscriptions` - 订阅记录
  - `promo_codes` - 优惠码
  - `prepaid_cards` - 点卡
  - `referral_codes` - 邀请码
  - `referrals` - 邀请关系
  - `orders` - 订单
  - `generation_jobs` - 生成任务

#### 2. 配置常量定义
- **文件**: `src/index.js` (内联) + `src/points/config.js` (模块化)
- **内容**:
  ```javascript
  POINTS_PER_IMAGE: 10        // 每张图片消耗积分
  SIGNUP_BONUS_POINTS: 100    // 新人注册奖励
  REFERRAL_BONUS_POINTS: 100  // 邀请奖励
  
  // 套餐定义
  Standard: ¥199/年, 每月 1000 积分
  Pro: ¥599/年, 每月 5000 积分
  
  // 优惠码
  DEFAULT_PERCENT_OFF: 20     // 默认 8 折
  ```

#### 3. 统一权益发放引擎
- **函数**: `grantPointsInternal(db, userId, delta, reason, refType, refId, idempotencyKey)`
- **特性**:
  - 幂等性保证（通过 idempotencyKey）
  - 事务操作（更新余额 + 写入账本）
  - 余额检查（消耗时）

#### 4. 新人注册赠送 100 积分
- **触发点**: 用户注册成功后
- **函数**: `grantSignupBonusPoints(db, userId)`
- **幂等键**: `signup_bonus:${userId}`

#### 5. 邀请码系统
- **功能**:
  - 自动生成邀请码（8位短码）
  - 注册时绑定邀请关系（`ref` 参数）
  - 防止自邀
  - 一个用户只能绑定一次
- **API**: `GET /api/referral/me`

#### 6. 优惠码系统
- **功能**:
  - 校验优惠码有效性
  - 计算折后价格
  - 支持百分比折扣
- **API**: `POST /api/promo/validate`

#### 7. 点卡兑换系统
- **功能**:
  - 支持订阅卡和积分卡
  - 点卡码格式：`XXXX-XXXX-XXXX-XXXX`
  - 兑换后自动发放权益
- **API**: 
  - `POST /api/prepaid/redeem` - 兑换点卡
  - `POST /api/admin/prepaid/create_batch` - 批量生成点卡

#### 8. 主入口集成
- **文件**: `src/index.js`
- **修改**:
  - 注册函数支持 `ref` 参数
  - 注册成功后发放新人积分
  - 添加积分系统 API 路由

---

#### 9. 前端页面开发
- **钱包页面** (`/wallet.html`)
  - 显示积分余额
  - 显示订阅状态
  - 积分流水记录
  - 快捷操作入口

- **兑换页面** (`/redeem.html`)
  - 点卡兑换（支持格式化输入）
  - 优惠码验证
  - 实时反馈结果

- **邀请页面** (`/invite.html`)
  - 专属邀请链接
  - 邀请统计数据
  - 社交分享按钮
  - 活动规则说明

- **定价页面** (`/pricing.html`)
  - 套餐对比展示
  - 优惠码应用
  - FAQ 常见问题

#### 10. 生成接口联动
- **后端新增 API**:
  - `POST /api/generation/pre-check` - 生成前检查积分
  - `POST /api/generation/confirm` - 确认生成完成，扣除积分
  - `GET /api/generation/status` - 获取用户生成状态
- **前端修改** (`app.js`):
  - `generateImage()` - 添加积分预检查和确认扣除
  - `checkPointsBeforeGeneration()` - 生成前检查积分
  - `confirmGenerationPoints()` - 确认扣除积分
  - `loadUserPointsBalance()` - 加载用户积分余额
- **邀请奖励触发**:
  - `checkAndGrantReferralReward()` - 被邀请人首次生成后触发奖励

#### 11. 首页钱包入口
- **修改文件**: `frontend/index.html`
- **新增内容**:
  - 用户下拉菜单添加"我的钱包"入口
  - 用户下拉菜单添加"邀请好友"入口
  - 显示实时积分余额

---

### ⏳ 待完成

#### 12. 创建 D1 数据库并执行迁移
**操作步骤**:
```bash
# 1. 创建 D1 数据库
npx wrangler d1 create gemini-points

# 2. 复制返回的 database_id，更新 wrangler.toml
# 将 YOUR_D1_DATABASE_ID 替换为实际的 ID

# 3. 执行迁移
npx wrangler d1 execute gemini-points --file=./migrations/0001_init_points_system.sql

# 4. 部署后端
npm run deploy
```

#### 10. 前端页面开发
- [ ] 钱包页面 (`/wallet`) - 显示积分余额、订阅状态、流水记录
- [ ] 兑换页面 (`/redeem`) - 输入点卡码/优惠码进行兑换
- [ ] 邀请页面 (`/invite`) - 显示邀请链接、邀请统计
- [ ] 套餐页面 (`/pricing`) - 显示套餐列表、购买入口

#### 11. 生成接口联动
- [ ] 生成图片时扣除积分
- [ ] 首次生成成功时触发邀请奖励
- [ ] 积分不足时提示用户

#### 12. 支付集成（可选）
- [ ] 支付宝/微信支付接口
- [ ] 订单创建和支付回调
- [ ] 支付成功后发放权益

---

## API 接口清单

| 状态 | 方法 | 路径 | 说明 |
|------|------|------|------|
| ✅ | GET | `/api/wallet/me` | 获取钱包信息 |
| ✅ | GET | `/api/wallet/transactions` | 积分流水 |
| ✅ | GET | `/api/referral/me` | 邀请码和统计 |
| ✅ | POST | `/api/promo/validate` | 校验优惠码 |
| ✅ | POST | `/api/prepaid/redeem` | 兑换点卡 |
| ✅ | GET | `/api/plans` | 套餐列表 |
| ✅ | POST | `/api/admin/prepaid/create_batch` | 批量生成点卡 |
| ✅ | POST | `/api/admin/promo/create` | 创建优惠码 |
| ✅ | POST | `/api/generation/pre-check` | 生成前检查积分 |
| ✅ | POST | `/api/generation/confirm` | 确认生成扣除积分 |
| ✅ | GET | `/api/generation/status` | 获取用户生成状态 |
| ⏳ | POST | `/api/orders/create` | 创建订单 |
| ⏳ | POST | `/api/webhook/payment` | 支付回调 |

---

## 文件清单

### 后端文件
| 文件 | 说明 |
|------|------|
| `migrations/0001_init_points_system.sql` | 数据库迁移脚本 |
| `src/index.js` | 主入口（含积分系统API） |
| `src/points/config.js` | 配置常量（模块化版本） |
| `src/points/engine.js` | 权益发放引擎（模块化版本） |
| `src/points/referral.js` | 邀请系统（模块化版本） |
| `src/points/promo.js` | 优惠码系统（模块化版本） |
| `src/points/prepaid.js` | 点卡系统（模块化版本） |
| `src/points/orders.js` | 订单系统（模块化版本） |
| `src/points/index.js` | 模块导出入口 |
| `wrangler.toml` | 已添加 D1 数据库绑定 |

### 前端文件
| 文件 | 说明 |
|------|------|
| `frontend/wallet.html` | 钱包页面 - 积分余额、订阅状态、流水记录 |
| `frontend/redeem.html` | 兑换页面 - 点卡兑换、优惠码验证 |
| `frontend/invite.html` | 邀请页面 - 邀请链接、统计、分享 |
| `frontend/pricing.html` | 定价页面 - 套餐对比、优惠码应用 |

### 文档文件
| 文件 | 说明 |
|------|------|
| `docs/积分系统设计.md` | 详细设计文档 |
| `docs/积分系统开发进度.md` | 开发进度跟踪（本文档） |

---

## 风控要点

1. **幂等性**: 所有发放权益的入口必须带 `idempotencyKey`
2. **防刷**:
   - 同一 invitee 只能绑定一次 inviter
   - inviter ≠ invitee（不能自邀）
   - 邀请奖励需被邀请人完成首次生成才发放
3. **Webhook 幂等**: 同一 `provider_tx_id` 只处理一次
