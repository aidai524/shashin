# 积分系统设计文档

## 一、需求规则常量

```javascript
// 积分规则
const POINTS_CONFIG = {
  POINTS_PER_IMAGE: 10,           // 每张图片消耗积分
  SIGNUP_BONUS_POINTS: 100,       // 新人注册赠送积分
  REFERRAL_BONUS_POINTS: 100,     // 邀请奖励积分（邀请人获得）
};

// 套餐定义（年费）
const SUBSCRIPTION_PLANS = {
  STANDARD: {
    id: 'standard',
    name: 'Standard',
    price: 199,                   // 年费价格（元）
    monthly_points: 1000,         // 每月发放积分
    duration_days: 365,
  },
  PRO: {
    id: 'pro', 
    name: 'Pro',
    price: 599,                   // 年费价格（元）
    monthly_points: 5000,         // 每月发放积分
    duration_days: 365,
  }
};

// 优惠码折扣（第一版只支持百分比折扣）
const PROMO_CONFIG = {
  DEFAULT_PERCENT_OFF: 20,        // 默认 8 折（即减 20%）
};

// 邀请奖励触发条件
const REFERRAL_CONFIG = {
  TRIGGER: 'first_generation',    // 首次生成成功时触发奖励
  // 可选值: 'first_generation' | 'first_payment'
};
```

---

## 二、数据库表设计（D1）

### 2.1 优惠码表 `promo_codes`

```sql
CREATE TABLE promo_codes (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  code TEXT UNIQUE NOT NULL,                    -- 优惠码（唯一）
  discount_type TEXT DEFAULT 'percent',         -- 折扣类型: percent/fixed
  discount_value INTEGER NOT NULL,              -- 折扣值（如 20 表示 8 折）
  max_uses INTEGER,                             -- 最大使用次数（NULL=无限）
  used_count INTEGER DEFAULT 0,                 -- 已使用次数
  applicable_products TEXT DEFAULT 'all',       -- 适用产品: all/subscription/points_pack/plan_id
  expires_at TEXT,                              -- 过期时间
  status TEXT DEFAULT 'active',                 -- 状态: active/disabled/expired
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  updated_at TEXT DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_promo_codes_code ON promo_codes(code);
CREATE INDEX idx_promo_codes_status ON promo_codes(status);
```

### 2.2 点卡表 `prepaid_cards`

```sql
CREATE TABLE prepaid_cards (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  code TEXT UNIQUE NOT NULL,                    -- 点卡码（唯一）
  card_type TEXT NOT NULL,                      -- 类型: subscription/points
  plan_id TEXT,                                 -- 套餐ID（若 subscription）
  points_amount INTEGER,                        -- 积分数量（若 points）
  status TEXT DEFAULT 'unused',                 -- 状态: unused/redeemed/void
  redeemed_by TEXT,                             -- 兑换用户ID
  redeemed_at TEXT,                             -- 兑换时间
  expires_at TEXT,                              -- 过期时间
  batch_id TEXT,                                -- 批次ID（方便追踪）
  created_at TEXT DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_prepaid_cards_code ON prepaid_cards(code);
CREATE INDEX idx_prepaid_cards_status ON prepaid_cards(status);
CREATE INDEX idx_prepaid_cards_batch ON prepaid_cards(batch_id);
```

### 2.3 邀请码表 `referral_codes`

```sql
CREATE TABLE referral_codes (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  code TEXT UNIQUE NOT NULL,                    -- 邀请码（唯一）
  owner_user_id TEXT NOT NULL,                  -- 所属用户ID
  created_at TEXT DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_referral_codes_code ON referral_codes(code);
CREATE INDEX idx_referral_codes_owner ON referral_codes(owner_user_id);
```

### 2.4 邀请关系表 `referrals`

```sql
CREATE TABLE referrals (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  inviter_user_id TEXT NOT NULL,                -- 邀请人ID
  invitee_user_id TEXT UNIQUE NOT NULL,         -- 被邀请人ID（唯一约束）
  source_code TEXT NOT NULL,                    -- 来源邀请码
  rewarded INTEGER DEFAULT 0,                   -- 是否已发放奖励: 0/1
  rewarded_at TEXT,                             -- 奖励发放时间
  created_at TEXT DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_referrals_inviter ON referrals(inviter_user_id);
CREATE INDEX idx_referrals_invitee ON referrals(invitee_user_id);
CREATE INDEX idx_referrals_rewarded ON referrals(rewarded);
```

### 2.5 积分账本表 `points_ledger`

```sql
CREATE TABLE points_ledger (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT NOT NULL,                        -- 用户ID
  delta INTEGER NOT NULL,                       -- 变动数量（正=增加，负=消耗）
  balance_after INTEGER NOT NULL,               -- 变动后余额
  reason TEXT NOT NULL,                         -- 原因类型
  -- reason 可选值:
  -- signup_bonus: 新人注册奖励
  -- referral_bonus: 邀请奖励
  -- monthly_grant: 月度发放
  -- prepaid: 点卡兑换
  -- purchase: 购买积分
  -- consume: 消耗（生成图片）
  -- refund: 退款
  ref_type TEXT,                                -- 关联类型: user/prepaid_card/order/generation
  ref_id TEXT,                                  -- 关联ID
  idempotency_key TEXT UNIQUE,                  -- 幂等键（防重复发放）
  created_at TEXT DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_points_ledger_user ON points_ledger(user_id);
CREATE INDEX idx_points_ledger_reason ON points_ledger(reason);
CREATE INDEX idx_points_ledger_idempotency ON points_ledger(idempotency_key);
```

### 2.6 用户钱包表 `user_wallets`

```sql
CREATE TABLE user_wallets (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT UNIQUE NOT NULL,                 -- 用户ID（唯一）
  points_balance INTEGER DEFAULT 0,             -- 积分余额
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  updated_at TEXT DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_user_wallets_user ON user_wallets(user_id);
```

### 2.7 订阅表 `subscriptions`

```sql
CREATE TABLE subscriptions (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT NOT NULL,                        -- 用户ID
  plan_id TEXT NOT NULL,                        -- 套餐ID: standard/pro
  status TEXT DEFAULT 'active',                 -- 状态: active/expired/cancelled
  start_at TEXT NOT NULL,                       -- 开始时间
  end_at TEXT NOT NULL,                         -- 结束时间
  last_monthly_grant_at TEXT,                   -- 上次月度发放时间
  source TEXT,                                  -- 来源: payment/prepaid/admin
  source_ref_id TEXT,                           -- 来源关联ID
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  updated_at TEXT DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_subscriptions_user ON subscriptions(user_id);
CREATE INDEX idx_subscriptions_status ON subscriptions(status);
CREATE INDEX idx_subscriptions_end ON subscriptions(end_at);
```

### 2.8 订单表 `orders`

```sql
CREATE TABLE orders (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  order_no TEXT UNIQUE NOT NULL,                -- 订单号
  user_id TEXT NOT NULL,                        -- 用户ID
  product_type TEXT NOT NULL,                   -- 产品类型: subscription/points_pack
  product_id TEXT NOT NULL,                     -- 产品ID: standard/pro/pack_100
  original_amount INTEGER NOT NULL,             -- 原价（分）
  discount_amount INTEGER DEFAULT 0,            -- 折扣金额（分）
  final_amount INTEGER NOT NULL,                -- 实付金额（分）
  promo_code TEXT,                              -- 使用的优惠码
  status TEXT DEFAULT 'pending',                -- 状态: pending/paid/cancelled/refunded
  paid_at TEXT,                                 -- 支付时间
  provider TEXT,                                -- 支付渠道: alipay/wechat
  provider_tx_id TEXT,                          -- 支付渠道交易ID
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  updated_at TEXT DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_orders_order_no ON orders(order_no);
CREATE INDEX idx_orders_user ON orders(user_id);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_provider_tx ON orders(provider_tx_id);
```

---

## 三、API 接口设计

### 3.1 邀请系统

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/referral/me` | 获取我的邀请码和统计 |
| POST | `/api/auth/register` | 注册时支持 `ref` 参数绑定邀请关系 |

### 3.2 优惠码

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/api/promo/validate` | 校验优惠码 |

### 3.3 点卡兑换

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/api/prepaid/redeem` | 兑换点卡 |

### 3.4 订单与支付

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/api/orders/create` | 创建订单（支持优惠码） |
| POST | `/api/webhook/payment` | 支付回调 |

### 3.5 钱包

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/wallet/me` | 获取我的钱包信息 |
| GET | `/api/wallet/transactions` | 获取积分流水 |

### 3.6 管理接口

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/api/admin/prepaid/create_batch` | 批量生成点卡 |
| POST | `/api/admin/promo/create` | 创建优惠码 |

---

## 四、核心函数设计

### 4.1 统一积分发放 `grantPoints`

```javascript
async function grantPoints(db, userId, delta, reason, refType, refId, idempotencyKey) {
  // 1. 检查幂等性：若 idempotencyKey 已存在，直接返回成功
  // 2. 事务操作：
  //    a. 获取/创建用户钱包
  //    b. 更新余额
  //    c. 写入账本记录
  // 3. 返回新余额
}
```

### 4.2 统一订阅发放 `grantSubscription`

```javascript
async function grantSubscription(db, userId, planId, durationDays, reason, refId) {
  // 1. 检查用户是否有 active 订阅
  //    - 有：延长 end_at
  //    - 无：创建新订阅
  // 2. 立即发放当月积分（提升用户体验）
  // 3. 返回订阅信息
}
```

---

## 五、开发顺序

1. ✅ 需求文档定稿
2. ⬜ 创建 D1 数据库和表
3. ⬜ 实现 grantPoints / grantSubscription
4. ⬜ 新人注册赠送 100 积分
5. ⬜ 邀请码生成 + 绑定 + 奖励
6. ⬜ 优惠码校验 + 下单应用
7. ⬜ 点卡兑换 + 批量生成
8. ⬜ 生成接口联动（扣积分 + 触发邀请奖励）
9. ⬜ 前端页面

---

## 六、风控要点

1. **幂等性**：所有发放权益的入口必须带 `idempotencyKey`
2. **防刷**：
   - 同一 invitee 只能绑定一次 inviter
   - inviter ≠ invitee（不能自邀）
   - 邀请奖励需被邀请人完成首次生成才发放
3. **Webhook 幂等**：同一 `provider_tx_id` 只处理一次
